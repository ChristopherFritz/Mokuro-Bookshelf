<!DOCTYPE html>
<html>
<head>
<title>Bookshelf</title>
<meta charset="utf-8"/>

<style>
div.section {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

div.box { text-align: center; }

div.images { border: solid thin black; }

div.imagebox {
  position: relative;
  border: solid thin black;
  line-height: 0;
}

div.imagebox a {
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 1;
  position: absolute;
}

div.pending {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  background-color: white;
  opacity: 0.75;
}

img { height: 180px; }

.progress-bar {
  background-color: #EEE;
  position: relative;
  border: solid thin black;
  margin-top: 3px;
  font-size: 12px;
}


.progress-bar-percentage {
  background-color: #8BD;
  padding: 5px 0px;
  color: #000;
  text-align: center;
  height: 1em;
}

.progress-bar-percentage > span {
  display: inline-block;
  position: absolute;
  width: 100%;
  left: 0;
}

/* If Migaku is enabled, hide the toolbar on this page. */
#migaku-toolbar-minimized { display: none !important;  }
</style>

<script>
function reading(mokuro, series, html) {

  const mokuroKey = `mokuro_${encodeURI(html)}`;
  const currentPage = mokuro.page_idx + 1;
  const totalPages = mokuro.last_page_idx;

  const percentComplete = parseInt(currentPage/totalPages*100);
  const percentRemaining = 100 - percentComplete;

  const volumeTitle = html.split('/').pop().replace('.html', '');

  const image = `${html.replace('.html', '')}/${mokuro.cover_page}`;
  const remainingPages = totalPages - currentPage;

  let progressStatus = 'reading';
  if (1 === currentPage)  {
    progressStatus = 'future';
  }
  else if (currentPage === totalPages) {
    progressStatus = 'finished';
  }

  let element = document.createElement('template');
  element.innerHTML = `
<div class="box" data-title="${volumeTitle}" data-current-page="${currentPage}" data-total-pages="${totalPages}" data-remaining-pages="${remainingPages}" data-progress-status="${progressStatus}" data-percent-complete="${percentComplete}" data-percent-remaining="${percentRemaining}" id="${mokuroKey}">

<div class="imagebox">
<a href="${html}"></a>
<img src="${image}">
<div class="pending" style="width: ${percentRemaining}%;"></div>
</div>

<div class="progress-bar">
<div class="progress-bar-percentage" style="width: ${percentComplete}%;">
<span><span class="progress">${percentComplete}</span>% (<span class="remaining">${remainingPages}</span>p)</span>
<span style="position: absolute; top: 0; right: 0; display: none;" onclick="deleteFromMokuro('${mokuroKey}')">❌</span>
</div>
`.trim();

  const containerElement = document.getElementById(progressStatus);
  containerElement.appendChild(element.content.firstChild);

}

function sortSection(sectionName, sortBy) {

  // Do nothing if section name is unknown.
  switch (sectionName) {
    case 'reading':
      break;
    case 'future':
      break;
    case 'finished':
      break;
    default:
      return;
  }

  const container = document.querySelector(`#${sectionName}`);
  const matches = container.querySelectorAll("[data-title]");

  var matchesArray = Array.from(matches);
  let sorted = matchesArray;

  switch (sortBy) {
    case 'title':
      sorted = matchesArray.sort((a, b) => a.dataset.title.localeCompare(b.dataset.title));
      break;
    default:
      return
  }
  sorted.forEach(e => document.querySelector(`#${sectionName}`).appendChild(e));

}

window.onstorage = event => {

  const boxElement = document.getElementById(event.key);
  const mokuro = JSON.parse(event.newValue);
  const totalPages = mokuro.last_page_idx;

  const currentPage = mokuro.page_idx + 1;
  const remainingPages = totalPages - currentPage;

  const percentComplete = parseInt(currentPage/totalPages*100);
  const percentRemaining = 100 - percentComplete;

  const currentProgressElement = boxElement.getElementsByClassName('progress')[0];
  currentProgressElement.innerText = parseInt(currentPage/totalPages*100);

  const remainingPagesElement = boxElement.getElementsByClassName('remaining')[0];
  remainingPagesElement.innerText = remainingPages;

  const pendingElement = boxElement.getElementsByClassName('pending')[0];
  pendingElement.style.width = percentRemaining + '%';

  const progressBarElement = boxElement.getElementsByClassName('progress-bar-percentage')[0];
  progressBarElement.style.width = percentComplete + '%';

};


function deleteFromMokuro(key) {
  // TODO: Show the correct pointer on hover for the ❌.
  // TODO: Have a confirmation dialogue.
  // TODO: Remove element from screen.
  localStorage.removeItem(key);
}

</script>

</head>

<body>

<h2>Reading</h2>

<div id="reading" class="section"></div>

<h2>Future</h2>

<div id="future" class="section"></div>

<h2>Finished</h2>

<div id="finished" class="section"></div>

<script>
const keys = Object.keys(localStorage)
const storagePrefix = "mokuro_"

for (let key of keys) {
  if (!key.startsWith(storagePrefix)) {
    continue;
  }
  const path = decodeURI(key.substring(storagePrefix.length));
  const fileName = path.split('/').pop().replace('.html', '');

  const mokuro = JSON.parse(localStorage.getItem(key));
  if (undefined === mokuro.cover_page) {
    continue;
  }

  const image = `${path.replace('.html', '')}/${mokuro.cover_page}`;


  reading(mokuro, fileName, path);

}

// Sort sections by title.
sortSection('reading', 'title');
sortSection('future', 'title');
sortSection('finished', 'title');
</script>

</body>

</html>
