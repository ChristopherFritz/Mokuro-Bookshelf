<!DOCTYPE html>
<html>
<head>
<title>Bookshelf</title>
<meta charset="utf-8"/>

<style>
div.section {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

div.box { text-align: center; position: relative; }

div.images { border: solid thin black; }

div.imagebox {
  position: relative;
  border: solid thin black;
  line-height: 0;
}

div.imagebox a {
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 1;
  position: absolute;
}

div.pending {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  background-color: white;
  opacity: 0.75;
}

img { height: 180px; }

.progress-bar {
  background-color: #EEE;
  position: relative;
  border: solid thin black;
  margin-top: 3px;
  font-size: 12px;
}


.progress-bar-percentage {
  background-color: #8BD;
  padding: 5px 0px;
  color: #000;
  text-align: center;
  height: 1em;
}

.progress-bar-percentage > span {
  display: inline-block;
  position: absolute;
  width: 100%;
  left: 0;
}

.delete {
  position: absolute;
  top: 0;
  right: 0;
  display: none;
}

.delete:hover {
  cursor: pointer;
}

/* If Migaku is enabled, hide the toolbar on this page. */
#migaku-toolbar-minimized { display: none !important;  }
</style>

<script>
function determineProgressStatus(currentPage, totalPages) {

  if (1 === currentPage)  {
    return 'future';
  }
  else if (currentPage === totalPages) {
    return 'finished';
  }
  else {
    return 'reading';
  }

}

function displayBook(mokuro, series, html) {

  const mokuroKey = `mokuro_${encodeURI(html)}`;
  const currentPage = mokuro.page_idx + 1;
  const totalPages = mokuro.last_page_idx;

  const percentComplete = parseInt(currentPage/totalPages*100);
  const percentRemaining = 100 - percentComplete;

  const volumeTitle = html.split('/').pop().replace('.html', '');

  const image = `${html.replace('.html', '')}/${mokuro.cover_page}`;
  const remainingPages = totalPages - currentPage;

  const progressStatus = determineProgressStatus(currentPage, totalPages)

  // Container for a single volume and its progress.
  const boxElement = document.createElement('div');
  boxElement.id = mokuroKey;
  boxElement.classList.add('box');
  boxElement.dataset.title = volumeTitle;
  boxElement.dataset.currentPage = currentPage;
  boxElement.dataset.totalPages = totalPages;
  boxElement.dataset.remainingPages = remainingPages;
  boxElement.dataset.progressStatus = progressStatus;
  boxElement.dataset.percentComplete = percentComplete;
  boxElement.dataset.percentRemaining= percentRemaining;

  // Container for the volume cover image and a link to the Mokuro HTML file.
  const imageBoxElement = document.createElement('div');
  imageBoxElement.classList.add('imagebox');
  // Link to the Mokuro HTML file.  This cannot contain the image or else the CSS box model seems to change.
  const imageBoxLinkElement = document.createElement('a');
  imageBoxLinkElement.href = html;
  imageBoxElement.appendChild(imageBoxLinkElement);
  // Image of the volume cover.
  const imageBoxImageElement = document.createElement('img');
  imageBoxImageElement.src = image;
  imageBoxElement.appendChild(imageBoxImageElement);
  // A white block with opacity set to make part of the volume cover image appear transparent based on one's reading progress.
  const pendingBoxElement = document.createElement('div');
  pendingBoxElement.classList.add('pending');
  pendingBoxElement.style.width = `${percentRemaining}%`;
  imageBoxElement.appendChild(pendingBoxElement);
  boxElement.appendChild(imageBoxElement);

  // Container for the progress bar.
  const progressBarElement = document.createElement('div');
  progressBarElement.classList.add('progress-bar');
  // Progress bar.
  const progressBarPercentageElement = document.createElement('div');
  progressBarPercentageElement.classList.add('progress-bar-percentage');
  progressBarPercentageElement.style.width = `${percentComplete}%`;
  // Outer span for centering progress text.
  const progressBarTextContainerElement = document.createElement('span');
  progressBarTextContainerElement.innerHTML = `<span class="progress">${percentComplete}</span>% (<span class="remaining">${remainingPages}</span>p)`
  progressBarPercentageElement.appendChild(progressBarTextContainerElement);
  progressBarElement.appendChild(progressBarPercentageElement);
  boxElement.appendChild(progressBarElement);

  // Delete icon.
  const deleteVolumeElement = document.createElement('span');
  deleteVolumeElement.classList.add('delete');
  deleteVolumeElement.addEventListener('click', deleteFromMokuro);
  deleteVolumeElement.innerText = '❌';
  progressBarElement.appendChild(deleteVolumeElement);

  const containerElement = document.getElementById(progressStatus);
  containerElement.appendChild(boxElement);

}

function sortSection(sectionName, sortBy) {

  // Do nothing if section name is unknown.
  switch (sectionName) {
    case 'reading':
      break;
    case 'future':
      break;
    case 'finished':
      break;
    default:
      return;
  }

  const container = document.querySelector(`#${sectionName}`);
  const matches = container.querySelectorAll("[data-title]");

  var matchesArray = Array.from(matches);
  let sorted = matchesArray;

  switch (sortBy) {
    case 'title':
      sorted = matchesArray.sort((a, b) => a.dataset.title.localeCompare(b.dataset.title));
      break;
    default:
      return
  }
  sorted.forEach(e => document.querySelector(`#${sectionName}`).appendChild(e));

}

window.onstorage = event => {

  const boxElement = document.getElementById(event.key);
  const mokuro = JSON.parse(event.newValue);
  const totalPages = mokuro.last_page_idx;

  const currentPage = mokuro.page_idx + 1;
  const remainingPages = totalPages - currentPage;

  const percentComplete = parseInt(currentPage/totalPages*100);
  const percentRemaining = 100 - percentComplete;

  const currentProgressElement = boxElement.getElementsByClassName('progress')[0];
  currentProgressElement.innerText = parseInt(currentPage/totalPages*100);

  const remainingPagesElement = boxElement.getElementsByClassName('remaining')[0];
  remainingPagesElement.innerText = remainingPages;

  const pendingElement = boxElement.getElementsByClassName('pending')[0];
  pendingElement.style.width = percentRemaining + '%';

  const progressBarElement = boxElement.getElementsByClassName('progress-bar-percentage')[0];
  progressBarElement.style.width = percentComplete + '%';

  // TODO: Need to move the book from one section to another and re-sort both sections, if applicable.
  const oldProgressStatus = boxElement.dataset.progressStatus;
  const newProgressStatus = determineProgressStatus(currentPage, totalPages);
  console.log(`${oldProgressStatus} VS ${newProgressStatus}`)
  if (oldProgressStatus !== newProgressStatus) {
    boxElement.dataset.progressStatus = newProgressStatus;
    const newContainerElement = document.getElementById(newProgressStatus);
    newContainerElement.appendChild(boxElement);
    sortSection(newProgressStatus, 'title');
  }


};


function deleteFromMokuro() {
  // TODO: Show the correct pointer on hover for the ❌.
  // TODO: Have a confirmation dialogue.
  // TODO: Remove element from screen.
  const volumeToRemove = event.srcElement.parentElement.parentElement;//.parentElement;
  volumeToRemove.remove();
  //localStorage.removeItem(volumeToRemove.id);
}

</script>

</head>

<body>

<h2>Reading</h2>

<div id="reading" class="section"></div>

<h2>Future</h2>

<div id="future" class="section"></div>

<h2>Finished</h2>

<div id="finished" class="section"></div>

<script>
const keys = Object.keys(localStorage)
const storagePrefix = "mokuro_"

for (let key of keys) {
  if (!key.startsWith(storagePrefix)) {
    continue;
  }
  const path = decodeURI(key.substring(storagePrefix.length));
  const fileName = path.split('/').pop().replace('.html', '');

  const mokuro = JSON.parse(localStorage.getItem(key));
  if (undefined === mokuro.cover_page) {
    continue;
  }

  const image = `${path.replace('.html', '')}/${mokuro.cover_page}`;


  displayBook(mokuro, fileName, path);

}

// Sort sections by title.
sortSection('reading', 'title');
sortSection('future', 'title');
sortSection('finished', 'title');
</script>

</body>

</html>
